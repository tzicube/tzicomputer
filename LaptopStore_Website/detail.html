<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TziComputer â€” Laptop Details</title>
  <link rel="icon" type="image/png" href="tzi-logo.png" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Contact FABs -->
  <div class="contact-fab" id="contactFab">
    <a class="cfab phone" href="tel:+886983596065" title="Call"></a>
    <a class="cfab line"  href="https://line.me/ti/p/NZ-yXJQcIf" target="_blank" rel="noopener" title="Line"></a>
    <a class="cfab fb"    href="https://www.facebook.com/tran.duy.424147" target="_blank" rel="noopener" title="Facebook"></a>
  </div>

  <!-- Header -->
  <header class="site-header">
    <div class="brand-left">
      <a class="brand-link" href="index.html" aria-label="TziComputer Home">
        <img class="brand-logo" src="tzi-logo.png" alt="TziComputer logo" />
      </a>
      <span class="brand-name">TziComputer</span>
    </div>
    <div class="searchbar center"></div>
    <div class="header-right"></div>
  </header>

  <!-- Detail -->
  <main class="detail-container">
    <div id="detail" class="detail-card"></div>
  </main>

  <!-- Footer (Ä‘Ãºng class BEM nhÆ° trong CSS) -->
  <footer class="tzi-footer">
    <div class="tzi-footer__inner">
      <div class="tzi-footer__brand">
        <img src="tzi-logo.png" alt="TziComputer" />
      </div>
      <div class="tzi-footer__credit">
        <div><span class="label">Chen Ba Wei :</span><strong>é™³å·´ç¶­</strong></div>
        <div><span class="label">Student Number :</span><strong>13361945</strong></div>
        <div><span class="label">MingChuan DaXue</span></div>
      </div>
    </div>
    <div class="tzi-footer__copy">Â© 2025 TziComputer â€” All rights reserved.</div>
  </footer>

  <!-- Order form -->
  <div id="orderModal" class="modal" aria-hidden="true">
    <div class="modal-box">
      <h3>Order information</h3>
      <form id="orderForm">
        <div class="form-row">
          <label>Full name</label>
          <input name="name" type="text" placeholder="Your name" required />
        </div>
        <div class="form-row">
          <label>Phone number</label>
          <input name="phone" type="tel" placeholder="e.g. 090..." required />
        </div>
        <div class="form-row">
          <label>Address</label>
          <input name="address" type="text" placeholder="Pickup address" required />
        </div>
        <div class="form-row">
          <label>Pickup date & time</label>
          <input name="pickup" type="datetime-local" required />
        </div>
        <div class="actions">
          <button type="button" class="btn-ghost" id="cancelBtn">Cancel</button>
          <button type="submit" class="btn-order" id="submitBtn">Confirm order</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Success popup -->
  <div id="successModal" class="modal" aria-hidden="true">
    <div class="modal-box">
      <h3>ðŸŽ‰ Order placed successfully</h3>
      <p>Your <strong>Order ID</strong> is: <strong id="orderCode" style="font-size:18px"></strong></p>
      <p class="hint">Please keep this ID for pickup verification.</p>
      <div class="actions">
        <button id="closeSuccess" class="btn-order">Got it</button>
      </div>
    </div>
  </div>

  <!-- Floating cart -->
  <div id="floatingCart" class="floating-cart" title="Orders">
    <img src="cart.png" alt="Cart" />
  
  </div>

  <!-- Phone mini popup (EN) -->
  <div id="phonePopup" class="mini-modal" aria-hidden="true">
    <div class="mini-box">
      <h3 style="margin:0 0 10px; text-align:center;">Call TziComputer</h3>
      <p id="copyPhone" style="font-weight:800;font-size:20px;margin:0 0 14px; text-align:center; cursor:pointer;">
        +886 983 596 065
      </p>
      <div style="display:flex;gap:10px;justify-content:center">
        <a id="callPhone" class="btn-order" href="tel:+886983596065" style="min-width:120px;text-align:center">Call</a>
        <button id="closePhone" class="btn-ghost" type="button" style="min-width:120px">Close</button>
      </div>
      <p class="hint" style="text-align:center;margin-top:10px">Tap the number to copy.</p>
    </div>
  </div>

  <!-- Data + helpers -->
  <script src="products.js"></script>
  <script src="orders.js"></script>

  <script>
    /* ================== CONFIG ================== */
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx0JZTIAP33w9vrB5M2mJPjOHdp4nEWsAitXDCUFnvBL8xINjKPvQeuZYAtHAnK_IE/exec";

    /* ===== Guard: náº¿u má»Ÿ detail.html khÃ´ng cÃ³ ?id ===== */
    (function guardDetail() {
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (!id) {
        const lastId = sessionStorage.getItem('lastProductId');
        if (lastId) location.replace(`detail.html?id=${lastId}`);
        else location.replace('index.html');
      }
    })();

    /* ===== Currency helpers ===== */
    const RATE_VND_TO_TWD = 0.0013;
    const extractVND = s => Number(String(s||"").replace(/[^\d]/g,""))||0;
    const vndToTwd = n => Math.round(n * RATE_VND_TO_TWD);
    const formatTWD = n => `NT$ ${n.toLocaleString('en-US')}`;

    /* ===== Order code tá»± tÄƒng ===== */
    const SEQ_KEY = 'ORDER_SEQ';
    function nextOrderCode(prefix='TZI-'){
      const cur = Number(localStorage.getItem(SEQ_KEY) || '0');
      localStorage.setItem(SEQ_KEY, String(cur + 1));
      return prefix + String(cur).padStart(4,'0');
    }

    /* ===== Fallback náº¿u thiáº¿u orders.js ===== */
    if (typeof addCurrentOrderToCart !== 'function') {
      window.addCurrentOrderToCart = function(order){
        const key = 'preorders';
        const list = JSON.parse(localStorage.getItem(key) || '[]');
        list.push(order);
        localStorage.setItem(key, JSON.stringify(list));
      }
    }
    if (typeof updatePreordersBadge !== 'function') {
      window.updatePreordersBadge = function(){
        const key = 'preorders';
        const list = JSON.parse(localStorage.getItem(key) || '[]');
        const el = document.getElementById('cartCount');
        if (el) el.textContent = list.length;
      }
    }

    async function sendToSheet(order){
      const form = new URLSearchParams();
      Object.entries(order).forEach(([k,v]) => form.append(k, String(v ?? '')));
      await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
        body: form.toString(),
        mode: 'no-cors'
      });
    }

    /* ===== Render chi tiáº¿t sáº£n pháº©m ===== */
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const product = Array.isArray(PRODUCTS) ? PRODUCTS.find(p => String(p.id)===String(id)) : null;

    const box = document.getElementById('detail');
    if (!product) {
      box.innerHTML = `<p class="empty">Laptop not found.</p>`;
    } else {
      const priceTwd = formatTWD(vndToTwd(extractVND(product.price)));
      box.innerHTML = `
        <div class="detail-image"><img src="${product.image}" alt="${product.name}" /></div>
        <div class="detail-info">
          <h2>${product.name}</h2>
          <p class="price">${priceTwd}</p>
          <ul class="specs">
            <li><strong>Brand:</strong> ${product.brand}</li>
            <li><strong>Purpose:</strong> ${product.purpose.join(', ')}</li>
            <li><strong>CPU:</strong> ${product.cpu}</li>
            <li><strong>GPU:</strong> ${product.gpu}</li>
            <li><strong>RAM:</strong> ${product.ram}</li>
            <li><strong>Storage:</strong> ${product.storage}</li>
            <li><strong>Display:</strong> ${product.display}</li>
          </ul>
          <div class="actions" style="margin-top:14px">
            <button class="btn-order" id="openOrder">Order now</button>
          </div>
          <p class="hint">Order and pick up at the counter.<br><strong>Address:</strong> MingChuan University</p>
        </div>
      `;
    }

    /* ===== Modal open/close ===== */
    const orderModal   = document.getElementById('orderModal');
    const successModal = document.getElementById('successModal');
    const orderCodeEl  = document.getElementById('orderCode');
    const submitBtn    = document.getElementById('submitBtn');

    document.getElementById('openOrder')?.addEventListener('click', () => {
      orderModal.classList.add('show');
      const input = document.querySelector('input[name="pickup"]');
      if (input){
        const now = new Date();
        const minStr = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
        input.min = minStr;
        if (!input.value){
          const tmr = new Date(now.getTime() + 86400000);
          tmr.setHours(10,0,0,0);
          input.value = new Date(tmr.getTime() - tmr.getTimezoneOffset()*60000).toISOString().slice(0,16);
        }
      }
    });

    document.getElementById('cancelBtn')?.addEventListener('click', () => orderModal.classList.remove('show'));
    document.getElementById('closeSuccess')?.addEventListener('click', () => successModal.classList.remove('show'));

    const form = document.getElementById('orderForm');
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const d = Object.fromEntries(new FormData(form).entries());
      const priceTwdText = formatTWD(vndToTwd(extractVND(product.price)));

      const code = nextOrderCode();
      const order = {
        orderCode: code,
        productId: product?.id || '',
        productName: product?.name || '',
        price: priceTwdText,
        name: (d.name||'').trim(),
        phone: (d.phone||'').trim(),
        address: (d.address||'').trim(),
        pickup: d.pickup || '',
        createdAt: new Date().toISOString()
      };

      addCurrentOrderToCart(order);

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        await sendToSheet(order);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Confirm order';
      }

      orderModal.classList.remove('show');
      orderCodeEl.textContent = code;
      successModal.classList.add('show');
      updatePreordersBadge();
    });

    updatePreordersBadge();

    /* ===== Phone popup ===== */
    (function () {
      const PHONE_NUM = '+886983596065';
      const phoneBtn  = document.querySelector('.cfab.phone');
      const popup     = document.getElementById('phonePopup');
      const copyP     = document.getElementById('copyPhone');
      const closeBtn  = document.getElementById('closePhone');
      const callBtn   = document.getElementById('callPhone');

      if (callBtn) callBtn.href = `tel:${PHONE_NUM.replace(/\s+/g,'')}`;

      phoneBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        popup?.classList.add('show');
      });
      popup?.addEventListener('click', (e) => {
        if (e.target === popup) popup.classList.remove('show');
      });
      closeBtn?.addEventListener('click', () => popup?.classList.remove('show'));

      copyP?.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(PHONE_NUM);
          const old = copyP.textContent;
          copyP.textContent = 'Copied!';
          setTimeout(() => copyP.textContent = old, 1100);
        } catch {}
      });
    })();
  </script>
</body>
</html>
